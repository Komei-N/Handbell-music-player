<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ハンドベル練習アプリ（シンセ版）</title>
<style>
  body { font-family: sans-serif; text-align: center; margin: 0; padding: 0; }
  #controls { margin: 20px; }
  #sheetContainer { width: 90%; height: 500px; margin: auto; border: 1px solid #ccc; overflow: hidden; position: relative; }
  #highlightBar { position: absolute; width: 3px; background: red; pointer-events: none; }
</style>
</head>
<body>

<h1>ハンドベル練習アプリ（シンセ版）</h1>

<div id="controls">
  <label>曲を選択:
    <select id="songSelect">
      <option value="bultava.xml">ブルタバ</option>
      <option value="koina.xml">小さな恋のうた</option>
      <option value="mrsgreen.xml">ミセスグリーンアップルメドレー</option>
    </select>
  </label>
  <button id="loadBtn">読み込み</button>
  <br><br>
  <label>テンポ (%): <input type="number" id="tempoInput" value="100" min="20" max="300">%</label>
  <button id="playBtn">再生</button>
  <button id="stopBtn">停止</button>
  <br><br>
  <label>パート選択: <input type="text" id="partSelect" placeholder="例: 1,2,3"></label>
  <label>音程選択: <input type="text" id="noteSelect" placeholder="例: C3,D4"></label>
</div>

<div id="sheetContainer">
  <div id="highlightBar"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/opensheetmusicdisplay/build/opensheetmusicdisplay.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.39/Tone.min.js"></script>
<script>
// ------------------- 初期設定 -------------------
let osmd, audioStarted=false;
let notesTimeline = [];
let highlightBar = document.getElementById('highlightBar');
let playTimeouts = [];

// ハンドベル風シンセサイザー
const bellSynth = new Tone.PolySynth(Tone.Synth, {
  oscillator: { type: "triangle" },
  envelope: { attack:0.01, decay:1.2, sustain:0.1, release:1.5 }
}).toDestination();

// ------------------- 曲読み込み -------------------
document.getElementById('loadBtn').addEventListener('click', async () => {
  const song = document.getElementById('songSelect').value;
  osmd = new opensheetmusicdisplay.OSMD(document.getElementById("sheetContainer"), {autoResize:true});
  await osmd.load(song);
  osmd.render();
  prepareNotesTimeline();
});

// ------------------- タイムライン作成 -------------------
function prepareNotesTimeline() {
  notesTimeline = [];
  const tempoPercent = document.getElementById('tempoInput').value / 100;
  const partFilter = document.getElementById('partSelect').value.split(',').map(x => x.trim());
  const noteFilter = document.getElementById('noteSelect').value.split(',').map(x => x.trim().toUpperCase());

  let currentTime = 0;
  const layout = osmd.GraphicSheet;

  layout.MeasureList.forEach(measure => {
    measure.Staves.forEach(staff => {
      staff.Voices.forEach(voice => {
        voice.Notes.forEach(note => {
          const pitch = note.Pitch ? note.Pitch.Name + note.Pitch.Octave : null;
          const partIndex = staff.ParentMeasure.ParentSourceStaffEntry.StaffIndex + 1;
          if((partFilter[0]=="" || partFilter.includes(partIndex.toString())) &&
             (noteFilter[0]=="" || noteFilter.includes(pitch))) {
            const durationSec = (note.Duration.RealValue / osmd.EngravingRules.Ticks) * (60 / osmd.Sheet.MajorUnit * 4) / tempoPercent;
            notesTimeline.push({note, start: currentTime, duration: durationSec});
            currentTime += durationSec;
          }
        });
      });
    });
  });
}

// ------------------- 再生 -------------------
document.getElementById('playBtn').addEventListener('click', async () => {
  if(!audioStarted){
    await Tone.start();
    audioStarted=true;
  }
  stopPlayback(); // 前回の再生停止
  notesTimeline.forEach((n,i)=>{
    playTimeouts.push(setTimeout(()=>{
      playNote(n);
    }, n.start*1000));
  });
});

// ------------------- 停止 -------------------
document.getElementById('stopBtn').addEventListener('click', stopPlayback);

function stopPlayback() {
  playTimeouts.forEach(t=>clearTimeout(t));
  playTimeouts=[];
}

// ------------------- 音符再生 & ハイライト -------------------
function playNote(n) {
  const pitch = n.note.Pitch ? n.note.Pitch.Name + n.note.Pitch.Octave : null;
  if(pitch) bellSynth.triggerAttackRelease(pitch, n.duration);
  highlightNote(n.note);
}

// ------------------- 赤バー表示（段跨ぎ対応） -------------------
function highlightNote(note) {
  if(!note) return;
  const bbox = note.getBoundingBox();
  highlightBar.style.top = bbox.y + "px";
  highlightBar.style.left = bbox.x + "px";
  highlightBar.style.height = bbox.height + "px";
  highlightBar.style.display = "block";
  const container = document.getElementById("sheetContainer");
  // 横スクロール調整（段を跨ぐ場合も対応）
  const leftPos = bbox.x - container.clientWidth/2 + bbox.width/2;
  container.scrollLeft = leftPos;
}
</script>

</body>
</html>
