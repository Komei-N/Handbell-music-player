<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Handbell MusicXML Player</title>
<style>
body{margin:0;font-family:sans-serif}
.app{max-width:1200px;margin:10px auto;padding:12px}
.row{display:flex;gap:12px;flex-wrap:wrap}
.left{width:360px}
.panel{padding:12px;border:1px solid #ccc;border-radius:6px;margin-top:12px}
.scoreContainer{position:relative;overflow:hidden;border:1px solid #ccc;border-radius:6px;height:400px}
#osmdCanvas{overflow-x:auto;white-space:nowrap;height:100%}
.cursorLine{position:absolute;top:0;width:3px;background:red;z-index:10;display:none}
label{display:block;margin-bottom:6px;font-size:13px}
input[type=range]{width:100%}
.partList label,.pitchList label{display:block;margin-bottom:4px;cursor:pointer}
.controls button{margin-right:6px}
.progress{height:8px;background:#eee;border-radius:4px;overflow:hidden;margin-top:6px}
.bar{height:100%;width:0;background:red}
</style>
</head>
<body>
<div class="app">
<header><h1>Handbell MusicXML Player</h1></header>
<div class="row">
<div class="left panel">
  <label>曲の選択</label>
  <select id="songSelect"></select>

  <div style="margin-top:12px">
    <label>演奏するパート</label>
    <div id="parts" class="partList"></div>
  </div>

  <div style="margin-top:12px">
    <label>演奏する音程</label>
    <div id="pitches" class="pitchList"></div>
  </div>

  <div style="margin-top:12px">
    <label>テンポ (%)</label>
    <input type="range" id="tempoPercent" min="20" max="300" value="100">
    <span id="tempoLabel">100%</span>
  </div>

  <div style="margin-top:12px">
    <label>音量 (dB)</label>
    <input type="range" id="volume" min="-24" max="6" value="-6">
  </div>

  <div class="controls" style="margin-top:12px">
    <button id="playBtn">再生</button>
    <button id="pauseBtn">一時停止</button>
    <button id="stopBtn">停止</button>
  </div>

  <div class="progress"><div class="bar" id="progressBar"></div></div>
  <div style="display:flex;justify-content:space-between;font-size:12px">
    <span id="timeLabel">0:00</span><span id="durationLabel">0:00</span>
  </div>
</div>
<div style="flex:1">
  <div class="panel scoreContainer">
    <div id="osmdCanvas"></div>
    <div class="cursorLine" id="cursorLine"></div>
  </div>
</div>
</div>
</div>

<script src="https://unpkg.com/opensheetmusicdisplay/build/opensheetmusicdisplay.min.js"></script>
<script src="https://unpkg.com/tone/build/Tone.js"></script>
<script>
// 曲リスト
const builtIn={
 "Song1":"music/song1.musicxml",
 "Song2":"music/song2.musicxml",
 "Song3":"music/song3.musicxml"
};

const songSelect=document.getElementById('songSelect');
const partsContainer=document.getElementById('parts');
const pitchesContainer=document.getElementById('pitches');
const tempoPercent=document.getElementById('tempoPercent');
const tempoLabel=document.getElementById('tempoLabel');
const volumeSlider=document.getElementById('volume');
const playBtn=document.getElementById('playBtn');
const pauseBtn=document.getElementById('pauseBtn');
const stopBtn=document.getElementById('stopBtn');
const progressBar=document.getElementById('progressBar');
const timeLabel=document.getElementById('timeLabel');
const durationLabel=document.getElementById('durationLabel');
const cursorLine=document.getElementById('cursorLine');
const osmdCanvas=document.getElementById('osmdCanvas');

let osmd=null;
let synth=null;
let volumeNode=null;
let parsedEvents=[];
let totalDuration=0;
let partNames=[];
let pitchNames=[];
let tonePart=null;

(async()=>{
 for(const k in builtIn){const opt=document.createElement('option');opt.value=k;opt.textContent=k;songSelect.appendChild(opt);}
 songSelect.addEventListener('change',()=>loadSong(songSelect.value));
 tempoPercent.addEventListener('input',()=>tempoLabel.textContent=tempoPercent.value+'%');
 volumeSlider.addEventListener('input',()=>{if(volumeNode)volumeNode.volume.value=parseInt(volumeSlider.value);});
 playBtn.addEventListener('click',playMusic);
 pauseBtn.addEventListener('click',()=>Tone.Transport.pause());
 stopBtn.addEventListener('click',stopMusic);

 synth=new Tone.FMSynth({harmonicity:8,modulationIndex:20,oscillator:{type:'sine'},
 envelope:{attack:0.001,decay:1.5,sustain:0,release:1.8},
 modulation:{type:'sine'},
 modulationEnvelope:{attack:0.001,decay:0.6,sustain:0,release:0.6}});
 volumeNode=new Tone.Volume(parseInt(volumeSlider.value)).toDestination();
 synth.connect(volumeNode);

 loadSong(Object.keys(builtIn)[0]);
})();

async function loadSong(name){
 const resp=await fetch(builtIn[name]);const xmlText=await resp.text();
 if(!osmd){
   osmd=new opensheetmusicdisplay.OpenSheetMusicDisplay(osmdCanvas,{drawingParameters:'compact',renderSingleHorizontalStaffline:true});
 }
 await osmd.load(xmlText);await osmd.render();

 const parsed=parseMusicXML(xmlText);
 parsedEvents=parsed.events;totalDuration=parsed.duration;

 // ここがポイント：空でも必ずUIが出る
 partNames=(parsed.parts.length?parsed.parts:["Part1","Part2","Part3"]);
 pitchNames=(parsed.pitchNames.length?parsed.pitchNames:["C3","D3","E3","F3","G3","A3","B3","C4"]);

 renderPartUI();renderPitchUI();
 durationLabel.textContent=formatTime(totalDuration);
 cursorLine.style.height=osmdCanvas.clientHeight+'px';
}

function parseMusicXML(xmlText){
 const parser=new DOMParser();const xml=parser.parseFromString(xmlText,'application/xml');
 const partNodes=[...xml.querySelectorAll('part')];
 const partList=[...xml.querySelectorAll('score-part')].map(p=>p.querySelector('part-name')?.textContent||p.getAttribute('id'));
 let events=[],pitchSet=new Set();
 partNodes.forEach((partNode,pi)=>{
   let divisions=1,tempo=120,timeSec=0;
   const measures=[...partNode.querySelectorAll('measure')];
   measures.forEach(measure=>{
     const attr=measure.querySelector('attributes');
     if(attr){const d=attr.querySelector('divisions');if(d)divisions=parseFloat(d.textContent);}
     const sound=measure.querySelector('direction > sound, sound');
     if(sound&&sound.getAttribute('tempo'))tempo=parseFloat(sound.getAttribute('tempo'));
     const notes=[...measure.querySelectorAll('note')];
     notes.forEach(note=>{
       const dur=parseFloat(note.querySelector('duration')?.textContent||0);
       if(note.querySelector('rest')){timeSec+=dur/divisions*(60/tempo);return;}
       const step=note.querySelector('pitch>step')?.textContent;
       const octave=parseInt(note.querySelector('pitch>octave')?.textContent);
       const alter=parseInt(note.querySelector('pitch>alter')?.textContent||0);
       const midi=pitchToMidi(step,octave,alter);
       const secs=dur/divisions*(60/tempo);
       pitchSet.add(step+octave);
       events.push({time:timeSec,duration:secs,midi,pitchName:step+octave,partIndex:pi});
       timeSec+=secs;
     });
   });
 });
 const duration=events.reduce((m,e)=>Math.max(m,e.time+e.duration),0);
 return {events,parts:partList,pitchNames:[...pitchSet],duration};
}
function pitchToMidi(step,oct,alter){const map={C:0,D:2,E:4,F:5,G:7,A:9,B:11};return (oct+1)*12+(map[step.toUpperCase()]||0)+alter;}

function renderPartUI(){
 partsContainer.innerHTML='';
 partNames.forEach((p,i)=>{
   const lab=document.createElement('label');
   lab.innerHTML=`<input type="checkbox" checked data-index="${i}">${p}`;
   partsContainer.appendChild(lab);
 });
}
function renderPitchUI(){
 pitchesContainer.innerHTML='';
 pitchNames.forEach(p=>{
   const lab=document.createElement('label');
   lab.innerHTML=`<input type="checkbox" checked data-pitch="${p}">${p}`;
   pitchesContainer.appendChild(lab);
 });
}

function playMusic(){
 if(!parsedEvents.length)return;
 const selectedParts=[...partsContainer.querySelectorAll('input')].map((i,idx)=>i.checked?idx:null).filter(i=>i!==null);
 const selectedPitches=[...pitchesContainer.querySelectorAll('input')].map(i=>i.checked?i.getAttribute('data-pitch'):null).filter(Boolean);
 if(!selectedParts.length||!selectedPitches.length){alert('パートまたはピッチが未選択です');return;}
 if(tonePart)tonePart.dispose();
 const tempo=parseInt(tempoPercent.value)/100;
 tonePart=new Tone.Part((time,v)=>{synth.triggerAttackRelease(Tone.Frequency(v.midi,'midi'),v.duration/tempo,time);},
 parsedEvents.filter(e=>selectedParts.includes(e.partIndex)&&selectedPitches.includes(e.pitchName))
 .map(e=>({time:e.time/tempo,duration:e.duration/tempo,midi:e.midi})));
 tonePart.start(0);Tone.Transport.start();
 Tone.Transport.scheduleRepeat(updateCursor,0.05);
}
function stopMusic(){if(tonePart)tonePart.dispose();Tone.Transport.stop();progressBar.style.width='0%';}
function updateCursor(){
 const sec=Tone.Transport.seconds;
 const percent=Math.min(sec/totalDuration*100,100);
 progressBar.style.width=percent+'%';timeLabel.textContent=formatTime(sec);
 const width=osmdCanvas.scrollWidth;
 cursorLine.style.display='block';cursorLine.style.left=percent/100*width+'px';
 osmdCanvas.scrollLeft=Math.max(0,cursorLine.offsetLeft-osmdCanvas.clientWidth/2);
}
function formatTime(s){const m=Math.floor(s/60);const sec=Math.floor(s%60);return m+':' + (sec<10?'0'+sec:sec);}
</script>
</body>
</html>
